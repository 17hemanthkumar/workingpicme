<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - PicMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.5s ease-in-out forwards; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="/homepage" class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-indigo-600" viewBox="0 0 32 32" fill="currentColor"><path d="M16 2L20 10H28L22 16L24 24L16 20L8 24L10 16L4 10H12L16 2Z"/><circle cx="16" cy="16" r="6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                    <span class="text-xl font-bold text-indigo-600">PicMe</span>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/homepage" class="text-gray-600 hover:text-indigo-600">Home</a>
                    <a href="/event_discovery" class="text-gray-600 hover:text-indigo-600">Events</a>
                    <a href="/personal_photo_gallery" class="text-gray-600 hover:text-indigo-600">My Photos</a>
                    <a href="/event_organizer" class="text-gray-600 hover:text-indigo-600">My Dashboard</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/logout" class="px-4 py-2 rounded-md text-sm font-medium text-red-600 border border-red-600 hover:bg-red-50">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <p id="event-category" class="text-sm font-semibold text-indigo-600 uppercase tracking-wider"></p>
            <h1 id="event-name" class="text-4xl font-bold text-gray-900 mt-2">Loading Event...</h1>
            <p id="event-date" class="text-lg text-gray-600 mt-2"></p>
            <a id="scan-face-link" href="#" class="mt-8 inline-block px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Scan My Face to Find My Photos
            </a>
        </div>

        <div class="border-t border-gray-200 pt-10">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Event Gallery - All Photos</h2>
            <div id="loading-message" class="text-center text-gray-500 py-8">Loading photos...</div>
            <div id="event-photos-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            </div>
        </div>
    </main>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center">
        <button id="close-modal" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300">&times;</button>
        <button id="prev-photo" class="absolute left-4 text-white text-4xl hover:text-gray-300">&#8249;</button>
        <button id="next-photo" class="absolute right-4 text-white text-4xl hover:text-gray-300">&#8250;</button>
        <div class="max-w-6xl max-h-screen p-4">
            <img id="modal-image" src="" class="max-w-full max-h-[80vh] object-contain mx-auto">
            <div class="text-center mt-4 space-x-4">
                <button id="download-photo" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Download</button>
                <button id="delete-photo" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
            <p id="modal-info" class="text-white text-center mt-2"></p>
        </div>
    </div>

    <script>
        let allPhotos = [];
        let currentPhotoIndex = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event_id');
            const eventNameEl = document.getElementById('event-name');
            const eventDateEl = document.getElementById('event-date');
            const eventCategoryEl = document.getElementById('event-category');
            const scanLink = document.getElementById('scan-face-link');
            const grid = document.getElementById('event-photos-grid');
            const loadingMessage = document.getElementById('loading-message');

            if (!eventId) {
                eventNameEl.textContent = "Event Not Found";
                loadingMessage.textContent = "No event ID provided in the URL.";
                return;
            }

            scanLink.href = `/biometric_authentication_portal?event_id=${eventId}`;

            // Load event details
            try {
                const eventResponse = await fetch(`/api/events/${eventId}`);
                const data = await eventResponse.json();
                if (data.success) {
                    const currentEvent = data.event;
                    eventNameEl.textContent = currentEvent.name;
                    eventCategoryEl.textContent = currentEvent.category || 'General';
                    eventDateEl.textContent = new Date(currentEvent.date).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                } else {
                    eventNameEl.textContent = "Event Not Found";
                }
            } catch (error) {
                console.error("Could not load event details:", error);
                eventNameEl.textContent = "Error Loading Event";
            }
            
            // Load ALL photos (including unprocessed)
            try {
                const photosResponse = await fetch(`/api/events/${eventId}/all-photos`);
                const data = await photosResponse.json();
                if (data.success && data.photos.length > 0) {
                    allPhotos = data.photos;
                    loadingMessage.style.display = 'none';
                    
                    grid.innerHTML = allPhotos.map((photo, index) => {
                        const statusBadge = photo.is_processed 
                            ? `<span class="absolute top-2 right-2 px-2 py-1 text-xs font-semibold rounded ${photo.type === 'group' ? 'bg-green-500' : 'bg-blue-500'} text-white">${photo.type}</span>`
                            : `<span class="absolute top-2 right-2 px-2 py-1 text-xs font-semibold rounded bg-yellow-500 text-white">No faces</span>`;
                        
                        return `
                            <div class="relative group cursor-pointer opacity-0 animate-fade-in" data-index="${index}">
                                <img src="${photo.url}" class="w-full h-48 object-cover rounded-lg shadow-md group-hover:shadow-xl transition-shadow" loading="lazy">
                                ${statusBadge}
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-opacity rounded-lg flex items-center justify-center">
                                    <svg class="w-12 h-12 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                                    </svg>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Add click handlers
                    document.querySelectorAll('#event-photos-grid > div').forEach(div => {
                        div.addEventListener('click', () => {
                            const index = parseInt(div.dataset.index);
                            openModal(index);
                        });
                    });
                } else {
                    loadingMessage.textContent = 'No photos uploaded to this event yet.';
                }
            } catch (error) {
                console.error("Could not load event photos:", error);
                loadingMessage.textContent = 'Failed to load photos. Please try again.';
            }
        });

        // Modal functions
        function openModal(index) {
            currentPhotoIndex = index;
            showPhoto();
            document.getElementById('image-modal').classList.remove('hidden');
            document.getElementById('image-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('image-modal').classList.add('hidden');
            document.getElementById('image-modal').classList.remove('flex');
        }

        function showPhoto() {
            const photo = allPhotos[currentPhotoIndex];
            document.getElementById('modal-image').src = photo.url;
            document.getElementById('modal-info').textContent = `${photo.filename} (${(photo.size / 1024).toFixed(2)} KB) - ${photo.type}`;
        }

        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % allPhotos.length;
            showPhoto();
        }

        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + allPhotos.length) % allPhotos.length;
            showPhoto();
        }

        async function downloadPhoto() {
            const photo = allPhotos[currentPhotoIndex];
            const link = document.createElement('a');
            link.href = photo.url;
            link.download = photo.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function deletePhoto() {
            if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                return;
            }

            const photo = allPhotos[currentPhotoIndex];
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event_id');

            try {
                const response = await fetch(`/api/photos/${eventId}/${photo.filename}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert('Photo deleted successfully!');
                    allPhotos.splice(currentPhotoIndex, 1);
                    
                    if (allPhotos.length === 0) {
                        closeModal();
                        location.reload();
                    } else {
                        if (currentPhotoIndex >= allPhotos.length) {
                            currentPhotoIndex = allPhotos.length - 1;
                        }
                        showPhoto();
                        location.reload(); // Reload to update grid
                    }
                } else {
                    alert('Failed to delete photo: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Failed to delete photo. Please try again.');
            }
        }

        // Event listeners
        document.getElementById('close-modal').addEventListener('click', closeModal);
        document.getElementById('next-photo').addEventListener('click', nextPhoto);
        document.getElementById('prev-photo').addEventListener('click', prevPhoto);
        document.getElementById('download-photo').addEventListener('click', downloadPhoto);
        document.getElementById('delete-photo').addEventListener('click', deletePhoto);

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('image-modal');
            if (!modal.classList.contains('hidden')) {
                if (e.key === 'Escape') closeModal();
                if (e.key === 'ArrowRight') nextPhoto();
                if (e.key === 'ArrowLeft') prevPhoto();
            }
        });

        // Click outside to close
        document.getElementById('image-modal').addEventListener('click', (e) => {
            if (e.target.id === 'image-modal') {
                closeModal();
            }
        });
    </script>
</body>
</html>