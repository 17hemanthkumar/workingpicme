<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Discovery - PicMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm sticky top-0 z-50">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="/homepage" class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-indigo-600" viewBox="0 0 32 32" fill="currentColor"><path d="M16 2L20 10H28L22 16L24 24L16 20L8 24L10 16L4 10H12L16 2Z"/><circle cx="16" cy="16" r="6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                    <span class="text-xl font-bold text-indigo-600">PicMe</span>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/homepage" class="text-gray-600 hover:text-indigo-600">Home</a>
                    <a href="/event_discovery" class="text-indigo-600 hover:text-indigo-600 font-bold">Events</a>
                    <a href="/personal_photo_gallery" class="text-gray-600 hover:text-indigo-600">My Photos</a>
                    <a href="/my_downloads" class="text-gray-600 hover:text-indigo-600">My Downloads</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/logout" class="px-4 py-2 rounded-md text-sm font-medium text-red-600 border border-red-600 hover:bg-red-50">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center bg-indigo-700 text-white p-10 rounded-xl shadow-lg">
            <h1 class="text-5xl font-bold">Discover Events</h1>
            <p class="mt-4 text-lg text-indigo-200">Search for an event below or scan an event QR code to get started.</p>
            
            <div class="mt-8 max-w-lg mx-auto">
                <div class="flex items-center space-x-4">
                    <button id="scan-camera-btn" class="w-full bg-white text-indigo-600 font-semibold py-3 px-4 rounded-lg shadow hover:bg-indigo-50 transition">
                        ðŸ“· Scan with Camera
                    </button>
                    <button id="upload-qr-btn" class="w-full bg-white text-indigo-600 font-semibold py-3 px-4 rounded-lg shadow hover:bg-indigo-50 transition">
                        ðŸ“¤ Upload QR Image
                    </button>
                    <input type="file" id="qr-file-input" accept="image/*" class="hidden">
                </div>
            </div>
        </div>

        <div id="reader" class="w-full max-w-md mx-auto mt-6 rounded-lg overflow-hidden bg-gray-200"></div>
        <div id="scan-status" class="text-center text-gray-600 mt-4 font-medium"></div>

        <div class="mt-16">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">All Events</h2>
                <div class="relative w-full max-w-md">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="event-search" placeholder="Search by event or organization name..." 
                           class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <button id="clear-search" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="search-results-count" class="text-sm text-gray-600 mb-4 hidden"></div>
            <div id="events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p id="loading-events" class="text-gray-500 col-span-full">Loading events...</p>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scanCameraBtn = document.getElementById('scan-camera-btn');
            const uploadQrBtn = document.getElementById('upload-qr-btn');
            const qrFileInput = document.getElementById('qr-file-input');
            const readerDiv = document.getElementById('reader');
            const scanStatus = document.getElementById('scan-status');

            const handleScanSuccess = (decodedText) => {
                scanStatus.textContent = `Success! Navigating...`;
                try {
                    const url = new URL(decodedText);
                    const eventId = url.searchParams.get("event_id");
                    if (eventId) { window.location.href = `/event_detail?event_id=${eventId}`; } 
                    else { throw new Error("No event_id in QR code."); }
                } catch (error) {
                    alert("This QR code is not a valid PicMe event link.");
                    scanStatus.textContent = '';
                }
            };
            
            uploadQrBtn.addEventListener('click', () => qrFileInput.click());
            qrFileInput.addEventListener('change', e => {
                if (e.target.files.length === 0) return;
                scanStatus.textContent = 'Scanning file...';
                const html5QrCode = new Html5Qrcode("reader");
                html5QrCode.scanFile(e.target.files[0], false).then(handleScanSuccess)
                    .catch(err => {
                        scanStatus.textContent = '';
                        alert(`Could not scan QR code from image.`);
                    });
            });

            let cameraScanner = null;
            scanCameraBtn.addEventListener('click', () => {
                if (cameraScanner && cameraScanner.isScanning) {
                    cameraScanner.stop().then(() => {
                        scanCameraBtn.innerHTML = 'ðŸ“· Scan with Camera';
                        readerDiv.style.display = 'none';
                        scanStatus.textContent = '';
                    });
                } else {
                    cameraScanner = new Html5Qrcode('reader');
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    readerDiv.style.display = 'block';
                    scanStatus.textContent = 'Starting camera...';
                    scanCameraBtn.innerHTML = 'â¹ï¸ Stop Camera';
                    cameraScanner.start({ facingMode: "environment" }, config, handleScanSuccess, () => {})
                        .catch(err => {
                            alert("Could not start camera. Please grant permissions.");
                            scanCameraBtn.innerHTML = 'ðŸ“· Scan with Camera';
                            readerDiv.style.display = 'none';
                            scanStatus.textContent = '';
                        });
                }
            });

            let allEvents = [];

            function displayEvents(events) {
                const grid = document.getElementById('events-grid');
                const resultsCount = document.getElementById('search-results-count');
                
                if (events.length === 0) {
                    grid.innerHTML = '<p class="text-gray-500 col-span-full">No events found matching your search.</p>';
                    resultsCount.classList.add('hidden');
                    return;
                }
                
                grid.innerHTML = events.map(event => `
                    <a href="/event_detail?event_id=${event.id}" class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow group">
                        <div class="relative">
                            <img src="${event.cover_thumbnail || '/static/images/default_event_thumbnail.jpg'}" alt="${event.name}" class="w-full h-48 object-cover">
                            <span class="absolute top-2 right-2 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${event.category || 'General'}</span>
                        </div>
                        <div class="p-4">
                            <h3 class="text-lg font-bold text-gray-900 group-hover:text-indigo-600">${event.name}</h3>
                            <p class="text-xs text-gray-500 mt-1">by ${event.organization_name || 'Unknown Organizer'}</p>
                            <p class="text-sm text-gray-600 mt-1">${event.location}</p>
                            <p class="text-sm text-gray-500 mt-1">${new Date(event.date).toLocaleDateString()}</p>
                        </div>
                    </a>
                `).join('');
            }

            function filterEvents(searchTerm) {
                const resultsCount = document.getElementById('search-results-count');
                
                if (!searchTerm.trim()) {
                    displayEvents(allEvents);
                    resultsCount.classList.add('hidden');
                    return;
                }
                
                const filtered = allEvents.filter(event => {
                    const searchLower = searchTerm.toLowerCase();
                    const orgName = (event.organization_name || 'Unknown Organizer').toLowerCase();
                    const eventName = (event.name || '').toLowerCase();
                    
                    // Search in both organization name and event name
                    return orgName.includes(searchLower) || eventName.includes(searchLower);
                });
                
                displayEvents(filtered);
                resultsCount.textContent = `Found ${filtered.length} event${filtered.length !== 1 ? 's' : ''}`;
                resultsCount.classList.remove('hidden');
            }

            async function loadEvents() {
                try {
                    // Add cache-busting timestamp to force fresh data
                    const response = await fetch(`/api/events?t=${Date.now()}`);
                    allEvents = await response.json();
                    document.getElementById('loading-events').style.display = 'none';
                    
                    if (allEvents.length === 0) {
                        document.getElementById('events-grid').innerHTML = '<p class="text-gray-500 col-span-full">No events have been created yet.</p>';
                        return;
                    }
                    
                    displayEvents(allEvents);
                } catch (error) {
                    console.error('Failed to load events:', error);
                    document.getElementById('loading-events').textContent = 'Could not load events.';
                }
            }

            // Search functionality
            const searchInput = document.getElementById('event-search');
            const clearSearchBtn = document.getElementById('clear-search');
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                filterEvents(searchTerm);
                
                // Show/hide clear button
                if (searchTerm) {
                    clearSearchBtn.classList.remove('hidden');
                } else {
                    clearSearchBtn.classList.add('hidden');
                }
            });
            
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                filterEvents('');
            });

            loadEvents();
        });
    </script>
</body>
</html>